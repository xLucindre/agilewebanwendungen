{% extends "base.html" %}
{% block page_title %}Monster Zones AP/DP Calc{% endblock %}
{% block header_title %}Monster Zones AP/DP Calc{% endblock %}

{% block content %}
    <div class="w-full max-w-screen-2xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6 p-6 rounded-lg shadow-lg">
        <!-- Character Stats Panel -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
            <h3 class="text-xl font-semibold mb-4 text-center">Your Stats</h3>
            <div class="space-y-4">
                <div class="text-center">
                    <div class="text-gray-400 text-sm">AP</div>
                    <div class="bg-gray-700 rounded px-3 py-2 text-lg font-bold text-white" id="player-ap">{{ ap|default_if_none:'-' }}</div>
                </div>
                <div class="text-center">
                    <div class="text-gray-400 text-sm">AAP</div>
                    <div class="bg-gray-700 rounded px-3 py-2 text-lg font-bold text-white" id="player-aap">{{ aap|default_if_none:'-' }}</div>
                </div>
                <div class="text-center">
                    <div class="text-gray-400 text-sm">DP</div>
                    <div class="bg-gray-700 rounded px-3 py-2 text-lg font-bold text-white" id="player-dp">{{ dp|default_if_none:'-' }}</div>
                </div>
            </div>
        </div>
        <!-- Monster Zones Panel -->
        <div class="lg:col-span-3 bg-gray-800 rounded-lg p-6 shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h3 class="text-xl font-semibold">Monster Zones</h3>
                <div class="flex flex-wrap gap-2 text-xs">
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span>Good</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-cyan-500 rounded-full"></div>
                        <span>Fine</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                        <span>Over AP Cap</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <span>Too Low AP</span>
                    </div>
                </div>
            </div>
            <!-- Zone Headers -->
            <div class="hidden lg:grid grid-cols-9 gap-2 text-xs text-gray-400 mb-2 px-2">
                <div class="col-span-2">Zone</div>
                <div class="text-center">Initial 5%</div>
                <div class="text-center">100%</div>
                <div class="text-center">Softcap 70%</div>
                <div class="text-center">Softcap 60%</div>
                <div class="text-center">Softcap 50%</div>
                <div class="text-center">Softcap 30%</div>
                <div class="text-center">Hard Cap</div>
            </div>
            <!-- Zone Lists -->
            <div id="zone-lists" class="space-y-6"></div>
        </div>
    </div>
    <script>
        // Monster zone data structure based on the images
        const monsterZones = {
            "Balenos": [
                {name: "Protty Cave", icon: "🔥", minAP: 1, maxAP: 242, softcaps: [280], type: "good"},
                {name: "Sycraia Underwater Ruins (Upper)", icon: "🌊", minAP: 1, maxAP: 342, softcaps: [380], type: "good"},
                {name: "Sycraia Abyssal Ruins (Lower)", icon: "🌊", minAP: 1, maxAP: 400, softcaps: [650], type: "good"}
            ],
            "Serendia": [
                {name: "Biraghi Den", icon: "⚔️", minAP: 1, maxAP: 410, softcaps: [753], type: "over-cap"},
                {name: "Altar Imp Habitat", icon: "🔥", minAP: 1, maxAP: 410, softcaps: [753], type: "over-cap"},
                {name: "Castle Ruins", icon: "🏰", minAP: 1, maxAP: 438, softcaps: [774], type: "over-cap"},
                {name: "Swamp Fogan Habitat", icon: "🐸", minAP: 1, maxAP: 476, softcaps: [803], type: "over-cap"},
                {name: "Swamp Naga Habitat", icon: "🐍", minAP: 1, maxAP: 476, softcaps: [803], type: "over-cap"},
                {name: "Orc Camp", icon: "👹", minAP: 1, maxAP: 368, softcaps: [856], type: "over-cap"},
                {name: "Bloody Monastery", icon: "⛪", minAP: 1, maxAP: 694, softcaps: [856], type: "over-cap"}
            ],
            "Calpheon": [
                {name: "Star's End", icon: "⭐", minAP: 1, maxAP: 392, softcaps: [650], type: "good"},
                {name: "Padix Island", icon: "🏝️", minAP: 1, maxAP: 400, softcaps: [700], type: "good"},
                {name: "Abandoned Monastery", icon: "⛪", minAP: 1, maxAP: 400, softcaps: [750], type: "good"},
                {name: "Saunil Camp", icon: "⚔️", minAP: 1, maxAP: 658, softcaps: [813], type: "over-cap"},
                {name: "Rhutum Outstation", icon: "🏺", minAP: 1, maxAP: 687, softcaps: [835], type: "over-cap"},
                {name: "Primal Giant Post", icon: "👹", minAP: 1, maxAP: 725, softcaps: [856], type: "over-cap"},
                {name: "Hexe Sanctuary", icon: "🧙", minAP: 1, maxAP: 792, softcaps: [898], type: "over-cap"},
                {name: "Troll Habitat", icon: "👹", minAP: 1, maxAP: 814, softcaps: [920], type: "over-cap"},
                {name: "[Dehkia] Cyclops Land", icon: "👁️", minAP: 1, maxAP: 910, softcaps: [1000], type: "good"}
            ],
            "Mediah": [
                {name: "Kratuga Ancient Ruins", icon: "🏛️", minAP: 1, maxAP: 342, softcaps: [600], type: "good"}
            ],
            "Valencia": [
                {name: "Desert Naga Temple", icon: "🐍", minAP: 1, maxAP: 157, softcaps: [213], type: "good"},
                {name: "Titium Valley", icon: "⛰️", minAP: 1, maxAP: 157, softcaps: [213], type: "good"},
                {name: "Bashim Base", icon: "🏴", minAP: 1, maxAP: 157, softcaps: [213], type: "good"},
                {name: "Gahaz Bandit's Lair", icon: "🗡️", minAP: 1, maxAP: 184, softcaps: [245], type: "good"},
                {name: "Crescent Shrine", icon: "🌙", minAP: 1, maxAP: 182, softcaps: [245], type: "good"},
                {name: "Cadry Ruins", icon: "🏛️", minAP: 1, maxAP: 178, softcaps: [245], type: "good"},
                {name: "Waragon Nest", icon: "🐉", minAP: 1, maxAP: 1, softcaps: [250], type: "good"},
                {name: "Centaurus Herd", icon: "🐎", minAP: 1, maxAP: 252, softcaps: [312], type: "good"},
                {name: "Basilisk Den", icon: "🦎", minAP: 1, maxAP: 252, softcaps: [320], type: "good"},
                {name: "Roud Sulfur Mine", icon: "⛏️", minAP: 1, maxAP: 307, softcaps: [365], type: "good"},
                {name: "Pila Ku Jail", icon: "🔒", minAP: 1, maxAP: 307, softcaps: [365], type: "good"},
                {name: "Hystria Ruins", icon: "🏛️", minAP: 1, maxAP: 384, softcaps: [600], type: "good"},
                {name: "Aakman Temple", icon: "🏛️", minAP: 1, maxAP: 347, softcaps: [600], type: "good"},
                {name: "[Dehkia] Aakman Temple", icon: "🏛️", minAP: 1, maxAP: 884, softcaps: [1000], type: "good"},
                {name: "[Dehkia] Hystria Ruins", icon: "🏛️", minAP: 1, maxAP: 884, softcaps: [1000], type: "good"},
                {name: "[Dehkia] Roud Sulfur Mine", icon: "⛏️", minAP: 1, maxAP: 884, softcaps: [1000], type: "good"},
                {name: "[Dehkia] Pila Ku Jail", icon: "🔒", minAP: 1, maxAP: 864, softcaps: [1000], type: "good"},
                {name: "[Dehkia] Crescent Shrine", icon: "🌙", minAP: 1, maxAP: 864, softcaps: [1000], type: "good"},
                {name: "[Dehkia] Cadry Ruins", icon: "🏛️", minAP: 1, maxAP: 1000, softcaps: [1000], type: "good"}
            ],
            "Kamasylvia": [
                {name: "Polly's Forest", icon: "🌸", minAP: 1, maxAP: 189, softcaps: [255], type: "good"},
                {name: "Fadus Habitat", icon: "🦌", minAP: 1, maxAP: 168, softcaps: [280], type: "over-cap"},
                {name: "Mirumok Ruins", icon: "🏛️", minAP: 1, maxAP: 350, softcaps: [380], type: "good"},
                {name: "Manshaum Forest", icon: "🌲", minAP: 1, maxAP: 363, softcaps: [410], type: "good"},
                {name: "Tooth Fairy Forest", icon: "🧚", minAP: 1, maxAP: 363, softcaps: [410], type: "good"},
                {name: "Gyfin Rhasia Temple", icon: "🏛️", minAP: 1, maxAP: 392, softcaps: [700], type: "good"},
                {name: "Ash Forest", icon: "🔥", minAP: 1, maxAP: 442, softcaps: [830], type: "good"},
                {name: "Gyfin Rhasia Underground", icon: "🏛️", minAP: 1, maxAP: 578, softcaps: [830], type: "good"},
                {name: "[Dehkia] Ash Forest", icon: "🔥", minAP: 1, maxAP: 866, softcaps: [1000], type: "good"},
                {name: "[Dehkia II] Ash Forest", icon: "🔥", minAP: 1, maxAP: 1075, softcaps: [1300], type: "too-low"}
            ],
            "Drieghan": [
                {name: "Tshira Ruins", icon: "🏛️", minAP: 1, maxAP: 184, softcaps: [245], type: "good"},
                {name: "Blood Wolf Settlement", icon: "🐺", minAP: 1, maxAP: 274, softcaps: [312], type: "good"},
                {name: "Sherekhan (Day)", icon: "☀️", minAP: 1, maxAP: 307, softcaps: [365], type: "good"},
                {name: "Sherekhan (Night)", icon: "🌙", minAP: 1, maxAP: 236, softcaps: [480], type: "good"}
            ],
            "O'dyllita": [
                {name: "Thornwood Forest", icon: "🌲", minAP: 1, maxAP: 384, softcaps: [600], type: "good"},
                {name: "Tunkuta", icon: "🗡️", minAP: 1, maxAP: 400, softcaps: [700], type: "good"},
                {name: "Olun's Valley", icon: "⛰️", minAP: 1, maxAP: 442, softcaps: [830], type: "good"},
                {name: "Crypt of Resting Thoughts", icon: "💀", minAP: 1, maxAP: 422, softcaps: [830], type: "good"},
                {name: "[Dehkia] Tunkuta", icon: "🗡️", minAP: 1, maxAP: 915, softcaps: [950], type: "over-cap"},
                {name: "[Dehkia] Olun's Valley", icon: "⛰️", minAP: 1, maxAP: 894, softcaps: [1000], type: "good"},
                {name: "[Dehkia] Thornwood Forest", icon: "🌲", minAP: 1, maxAP: 864, softcaps: [1000], type: "good"},
                {name: "[Dehkia II] Olun's Valley", icon: "⛰️", minAP: 1, maxAP: 1215, softcaps: [1300], type: "too-low"}
            ],
            "Snow Mountain": [
                {name: "Murrowak's Labyrinth", icon: "🧩", minAP: 1, maxAP: 452, softcaps: [730], type: "over-cap"},
                {name: "Jade Starlight Forest", icon: "💎", minAP: 1, maxAP: 631, softcaps: [734], type: "over-cap"}
            ],
            "Ulukita": [
                {name: "City of the Dead", icon: "💀", minAP: 1, maxAP: 889, softcaps: [1100], type: "good"},
                {name: "Tungrad Ruins", icon: "🏛️", minAP: 1, maxAP: 957, softcaps: [1100], type: "good"},
                {name: "Yzrahid Highlands", icon: "⛰️", minAP: 1, maxAP: 926, softcaps: [1100], type: "good"},
                {name: "Darkseeker's Retreat", icon: "🌑", minAP: 1, maxAP: 949, softcaps: [1150], type: "good"}
            ],
            "Land of the Morning Light": [
                {name: "Honglim Base", icon: "🏯", minAP: 1, maxAP: 744, softcaps: [850], type: "over-cap"},
                {name: "Dokkebi Forest", icon: "👹", minAP: 1, maxAP: 1022, softcaps: [1300], type: "too-low"}
            ]
        };

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        function loadStatsFromGearPlanner() {
            // Versuche zuerst die Werte aus dem Template zu lesen
            const apElem = document.getElementById('player-ap');
            const aapElem = document.getElementById('player-aap');
            const dpElem = document.getElementById('player-dp');
            let ap = apElem ? apElem.textContent : '-';
            let aap = aapElem ? aapElem.textContent : '-';
            let dp = dpElem ? dpElem.textContent : '-';

            // Wenn Werte gesetzt und gültig, verwende sie
            if (ap !== '-' && aap !== '-' && dp !== '-') {
                return { ap: parseInt(ap) || 0, aap: parseInt(aap) || 0, dp: parseInt(dp) || 0 };
            }

            // Fallback zu localStorage
            const saved = localStorage.getItem('bdoGearState');
            if (saved) {
                const gearState = JSON.parse(saved);
                let totalAP = 0;
                let totalAAP = 0;
                let totalDP = 0;
                Object.entries(gearState.currentStats || {}).forEach(([slot, stats]) => {
                    if (stats) {
                        let ap = 0;
                        if (stats.ap) {
                            const apStr = String(stats.ap);
                            const match = apStr.match(/(\d+)/);
                            ap = match ? parseInt(match[1]) : 0;
                        }
                        const dp = parseInt(stats.dp || 0);
                        if (slot === 'main_weapon') {
                            totalAP += ap;
                        } else if (slot === 'awakening_weapon') {
                            totalAAP += ap;
                        } else {
                            totalAP += ap;
                            totalAAP += ap;
                        }
                        totalDP += dp;
                    }
                });
                if (apElem) apElem.textContent = totalAP || '-';
                if (aapElem) aapElem.textContent = totalAAP || '-';
                if (dpElem) dpElem.textContent = totalDP || '-';
                return { ap: totalAP, aap: totalAAP, dp: totalDP };
            }
            // No stats available
            if (apElem) apElem.textContent = '-';
            if (aapElem) aapElem.textContent = '-';
            if (dpElem) dpElem.textContent = '-';
            return { ap: 0, aap: 0, dp: 0 };
        }

        function applyManualStats() {
            const manualAP = parseInt(document.getElementById('manual-ap').value) || 0;
            const manualAAP = parseInt(document.getElementById('manual-aap').value) || 0;
            const manualDP = parseInt(document.getElementById('manual-dp').value) || 0;
            
            document.getElementById('player-ap').textContent = manualAP || '-';
            document.getElementById('player-aap').textContent = manualAAP || '-';
            document.getElementById('player-dp').textContent = manualDP || '-';
            
            renderMonsterZones();
        }

        function renderMonsterZones() {
            const container = document.getElementById('zone-lists');
            const playerAP = parseInt(document.getElementById('player-ap').textContent) || 0;
            const playerAAP = parseInt(document.getElementById('player-aap').textContent) || 0;
            const effectiveAP = Math.max(playerAP, playerAAP); // Use the higher AP value
            
            container.innerHTML = '';

            Object.entries(monsterZones).forEach(([region, zones]) => {
                const regionDiv = document.createElement('div');
                regionDiv.className = 'mb-6';
                
                const regionHeader = document.createElement('h4');
                regionHeader.className = 'text-lg font-semibold mb-3 text-red-400 border-b border-gray-700 pb-2';
                regionHeader.textContent = region;
                regionDiv.appendChild(regionHeader);

                const zoneGrid = document.createElement('div');
                zoneGrid.className = 'space-y-2';

                zones.forEach(zone => {
                    const zoneRow = document.createElement('div');
                    zoneRow.className = 'zone-row grid grid-cols-1 lg:grid-cols-9 gap-2 p-3 bg-gray-700 rounded-lg items-center';

                    // Zone name and icon
                    const nameCell = document.createElement('div');
                    nameCell.className = 'lg:col-span-2 flex items-center gap-2';
                    nameCell.innerHTML = `
                        <span class="text-lg">${zone.icon}</span>
                        <span class="font-medium">${zone.name}</span>
                    `;

                    // AP requirements columns
                    const apCells = [];
                    
                    // Initial 5% (1 - maxAP)
                    const initialCell = document.createElement('div');
                    initialCell.className = 'text-center text-sm hidden lg:block';
                    initialCell.textContent = `${zone.minAP} - ${zone.maxAP}`;
                    if (effectiveAP >= zone.minAP && effectiveAP <= zone.maxAP) {
                        initialCell.className += ' text-red-400 font-bold';
                    }
                    apCells.push(initialCell);

                    // 100% (maxAP+1 - softcap)
                    const hundredCell = document.createElement('div');
                    hundredCell.className = 'text-center text-sm hidden lg:block';
                    if (zone.softcaps[0]) {
                        hundredCell.textContent = `${zone.maxAP + 1} - ${zone.softcaps[0]}`;
                        if (effectiveAP > zone.maxAP && effectiveAP <= zone.softcaps[0]) {
                            hundredCell.className += ' text-cyan-400 font-bold';
                        }
                    } else {
                        hundredCell.textContent = '-';
                    }
                    apCells.push(hundredCell);

                    // Softcap columns
                    const softcapCell = document.createElement('div');
                    softcapCell.className = 'text-center text-sm hidden lg:block';
                    if (zone.softcaps[0]) {
                        softcapCell.textContent = `>${zone.softcaps[0]}`;
                        if (effectiveAP > zone.softcaps[0]) {
                            softcapCell.className += ' text-green-400 font-bold';
                        }
                    } else {
                        softcapCell.textContent = '-';
                    }
                    apCells.push(softcapCell);

                    // Empty cells for other softcap columns
                    for (let i = 0; i < 4; i++) {
                        const emptyCell = document.createElement('div');
                        emptyCell.className = 'text-center text-sm hidden lg:block text-gray-500';
                        emptyCell.textContent = '-';
                        apCells.push(emptyCell);
                    }

                    // Mobile view
                    const mobileInfo = document.createElement('div');
                    mobileInfo.className = 'lg:hidden mt-2 text-sm';
                    
                    let statusText = '';
                    let statusColor = '';
                    
                    if (effectiveAP === 0) {
                        statusText = 'No gear data';
                        statusColor = 'text-gray-400';
                    } else if (effectiveAP < zone.minAP) {
                        statusText = 'Too low AP';
                        statusColor = 'text-red-400';
                    } else if (effectiveAP <= zone.maxAP) {
                        statusText = 'Initial range (5% drop rate)';
                        statusColor = 'text-red-400';
                    } else if (zone.softcaps[0] && effectiveAP <= zone.softcaps[0]) {
                        statusText = 'Efficient range (100% drop rate)';
                        statusColor = 'text-cyan-400';
                    } else if (zone.softcaps[0] && effectiveAP > zone.softcaps[0]) {
                        statusText = 'Over softcap (Diminishing returns)';
                        statusColor = 'text-green-400';
                    }
                    
                    mobileInfo.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-gray-300">AP Range:</span>
                            <span class="font-medium">${zone.minAP} - ${zone.maxAP}</span>
                        </div>
                        ${zone.softcaps[0] ? `<div class="flex justify-between items-center mb-1">
                            <span class="text-gray-300">Softcap:</span>
                            <span class="font-medium">${zone.softcaps[0]}</span>
                        </div>` : ''}
                        <div class="flex justify-between items-center">
                            <span class="text-gray-300">Status:</span>
                            <span class="${statusColor} font-medium">${statusText}</span>
                        </div>
                    `;

                    // Add visual indicator bar for mobile
                    const progressBar = document.createElement('div');
                    progressBar.className = 'lg:hidden mt-2 w-full bg-gray-600 rounded-full h-2';
                    
                    const progressFill = document.createElement('div');
                    progressFill.className = 'h-2 rounded-full transition-all duration-300';
                    
                    let fillWidth = 0;
                    let fillColor = 'bg-gray-500';
                    
                    if (effectiveAP > 0 && effectiveAP >= zone.minAP) {
                        if (effectiveAP <= zone.maxAP) {
                            fillWidth = Math.min(((effectiveAP - zone.minAP) / (zone.maxAP - zone.minAP)) * 30, 30);
                            fillColor = 'bg-red-400';
                        } else if (zone.softcaps[0] && effectiveAP <= zone.softcaps[0]) {
                            fillWidth = 30 + Math.min(((effectiveAP - zone.maxAP) / (zone.softcaps[0] - zone.maxAP)) * 50, 50);
                            fillColor = 'bg-cyan-400';
                        } else if (zone.softcaps[0] && effectiveAP > zone.softcaps[0]) {
                            fillWidth = 80 + Math.min(((effectiveAP - zone.softcaps[0]) / 100) * 20, 20);
                            fillColor = 'bg-green-400';
                        }
                    }
                    
                    progressFill.style.width = `${fillWidth}%`;
                    progressFill.className += ` ${fillColor}`;
                    progressBar.appendChild(progressFill);

                    zoneRow.appendChild(nameCell);
                    apCells.forEach(cell => zoneRow.appendChild(cell));
                    zoneRow.appendChild(mobileInfo);
                    zoneRow.appendChild(progressBar);
                    
                    zoneGrid.appendChild(zoneRow);
                });

                regionDiv.appendChild(zoneGrid);
                container.appendChild(regionDiv);
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load stats from gear planner
            loadStatsFromGearPlanner();
            
            // Render monster zones
            renderMonsterZones();
            
            // Listen for changes in manual input fields
            ['manual-ap', 'manual-aap', 'manual-dp'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    // Auto-apply changes on input
                    setTimeout(applyManualStats, 300);
                });
            });
            
            // Refresh stats every 5 seconds in case gear planner data changes
            setInterval(() => {
                const currentAP = document.getElementById('player-ap').textContent;
                const currentAAP = document.getElementById('player-aap').textContent;
                const currentDP = document.getElementById('player-dp').textContent;
                
                loadStatsFromGearPlanner();
                
                const newAP = document.getElementById('player-ap').textContent;
                const newAAP = document.getElementById('player-aap').textContent;
                const newDP = document.getElementById('player-dp').textContent;
                
                // Only re-render if stats changed
                if (currentAP !== newAP || currentAAP !== newAAP || currentDP !== newDP) {
                    renderMonsterZones();
                }
            }, 5000);
        });

        // Listen for storage changes (when gear planner updates)
        window.addEventListener('storage', function(e) {
            if (e.key === 'bdoGearState') {
                loadStatsFromGearPlanner();
                renderMonsterZones();
            }
        });
    </script>
{% endblock %}